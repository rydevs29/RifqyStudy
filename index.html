<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RifqyStudy – Belajar 10x Cepat</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#ff6b6b">
  <style>
    :root {
      --primary: #ff6b6b;
      --bg: #0a0a1a;
      --card: #1a1a2e;
      --text: #ffffff;
      --border: rgba(255, 107, 107, 0.4);
    }
    @media (prefers-color-scheme: light) {
      :root { --bg: #f8f9fa; --card: #ffffff; --text: #212529; --border: rgba(255,107,107,0.6); }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 24px; }
    h1 { font-size: 28px; color: var(--primary); margin-bottom: 8px; }
    .subtitle { opacity: 0.8; font-size: 15px; }
    .card { background: var(--card); border-radius: 24px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); margin-bottom: 20px; }
    .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    button { background: var(--primary); color: #000; border: none; padding: 14px 20px; border-radius: 16px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.2s; flex: 1; min-width: 120px; }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(255,107,107,0.4); }
    button.recording { background: #00ff88; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    .btn-secondary { background: rgba(255,255,255,0.1); color: var(--text); }
    select { padding: 14px; border-radius: 16px; background: rgba(0,0,0,0.1); color: var(--text); border: 2px solid var(--border); flex: 1; }
    .timer { font-family: 'Courier New', monospace; font-size: 18px; font-weight: bold; color: var(--primary); text-align: center; margin: 12px 0; padding: 8px; background: rgba(255,107,107,0.1); border-radius: 12px; display: none; }
    .pomodoro { font-family: 'Courier New', monospace; font-size: 24px; font-weight: bold; color: var(--primary); text-align: center; margin: 12px 0; padding: 12px; background: rgba(255,107,107,0.1); border-radius: 16px; display: none; }
    textarea { width: 100%; padding: 16px; border: 2px solid var(--border); border-radius: 16px; background: rgba(0,0,0,0.1); color: var(--text); font-size: 16px; resize: vertical; min-height: 120px; margin-bottom: 16px; }
    .ai-output { background: rgba(255,107,107,0.15); padding: 16px; border-radius: 16px; border-left: 4px solid var(--primary); margin: 16px 0; display: none; }
    .notes-list { margin-top: 20px; }
    .note-item { background: rgba(255,255,255,0.05); padding: 16px; border-radius: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
    .note-actions { display: flex; gap: 8px; font-size: 13px; }
    .note-actions button { padding: 6px 12px; font-size: 13px; flex: 1; }
    .empty-state { text-align: center; padding: 40px 20px; opacity: 0.6; font-style: italic; }
    .limit { color: #ff6b6b; font-size: 14px; text-align: center; margin: 12px 0; }
    footer { text-align: center; margin-top: 32px; font-size: 13px; opacity: 0.7; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>RifqyStudy</h1>
      <p class="subtitle">Rekam Guru → AI Bikin Soal!</p>
      <p class="limit">Batas rekam: 10 menit (versi gratis)</p>
    </div>

    <div class="card">
      <div class="controls">
        <button id="record-btn" onclick="toggleRecord()">Rekam</button>
        <select id="subject">
          <option>IPA</option>
          <option>IPS</option>
          <option>Matematika</option>
          <option>Bahasa</option>
        </select>
        <button class="btn-secondary" onclick="startPomodoro()">Pomodoro</button>
      </div>

      <div id="timer" class="timer">00:00:00</div>
      <div id="pomodoro" class="pomodoro">25:00</div>

      <textarea id="note-input" placeholder="Hasil rekaman muncul di sini..."></textarea>

      <div class="controls">
        <button class="btn-secondary" onclick="generateSummary()">Ringkas</button>
        <button class="btn-secondary" onclick="generateQuiz()">Buat Soal</button>
        <button class="btn-secondary" onclick="exportPDF()">PDF</button>
        <button class="btn-secondary" onclick="saveNote()">Simpan</button>
      </div>

      <div id="ai-output" class="ai-output">
        <strong>Hasil AI:</strong><br>
        <div id="ai-text"></div>
      </div>
    </div>

    <div class="card">
      <h3>Materi Tersimpan</h3>
      <div id="notes-list">
        <div class="empty-state">Belum ada materi.</div>
      </div>
    </div>

    <footer>
      © 2025 RifqyStudy | 
      <a href="https://wa.me/6287759652715" style="color:var(--primary); text-decoration:none;">Upgrade ke PRO (90 menit)</a>
    </footer>
  </div>

  <script>
    // BATAS 10 MENIT = 600 detik
    const MAX_RECORD_TIME = 600;
    let isRecording = false, startTime, recordTimer, finalTranscript = '';
    const recordBtn = document.getElementById('record-btn');
    const timerEl = document.getElementById('timer');

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = SpeechRecognition ? new SpeechRecognition() : null;
    if (recognition) {
      recognition.lang = 'id-ID'; recognition.continuous = true; recognition.interimResults = true;
    }

    function toggleRecord() {
      if (!recognition) return alert('Browser tidak mendukung rekam suara.');
      if (isRecording) {
        recognition.stop();
        clearInterval(recordTimer);
        timerEl.style.display = 'none';
        recordBtn.textContent = 'Rekam';
        recordBtn.classList.remove('recording');
        isRecording = false;
      } else {
        finalTranscript = document.getElementById('note-input').value || '';
        startTime = Date.now();
        recognition.start();
        recordBtn.textContent = 'Stop';
        recordBtn.classList.add('recording');
        timerEl.style.display = 'block';
        isRecording = true;

        recordTimer = setInterval(() => {
          const elapsed = Math.floor((Date.now() - startTime) / 1000);
          const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
          const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
          const s = String(elapsed % 60).padStart(2, '0');
          timerEl.textContent = `${h}:${m}:${s}`;

          if (elapsed >= MAX_RECORD_TIME) {
            toggleRecord();
            alert('Batas 10 menit tercapai! Upgrade ke PRO untuk rekam 90 menit.');
          }
        }, 500);
      }
    }

    if (recognition) {
      recognition.onresult = e => {
        let interim = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          const t = e.results[i][0].transcript;
          if (e.results[i].isFinal) finalTranscript += t + ' ';
          else interim += t;
        }
        document.getElementById('note-input').value = finalTranscript + interim;
      };
      recognition.onend = () => { if (isRecording) setTimeout(() => recognition.start(), 100); };
    }

    // POMODORO
    let pomodoroInterval;
    function startPomodoro() {
      let time = 25 * 60;
      const el = document.getElementById('pomodoro');
      el.style.display = 'block';
      pomodoroInterval = setInterval(() => {
        time--;
        const m = String(Math.floor(time/60)).padStart(2,'0');
        const s = String(time%60).padStart(2,'0');
        el.textContent = `${m}:${s}`;
        if (time <= 0) { clearInterval(pomodoroInterval); el.textContent = 'Waktu Habis!'; }
      }, 1000);
    }

    // AI
    function generateSummary() {
      const text = document.getElementById('note-input').value.trim();
      if (!text) return alert('Rekam dulu!');
      const sentences = text.split(/[.!?]/g).map(s => s.trim()).filter(s => s.length > 10);
      const summary = sentences.slice(0, 3).join('. ') + (sentences.length > 3 ? '...' : '.');
      showAI(`Ringkasan:\n${summary}`);
    }

    function generateQuiz() {
      const text = document.getElementById('note-input').value.trim();
      if (!text) return alert('Rekam dulu!');
      const sentences = text.split(/[.!?]/g).map(s => s.trim()).filter(s => s.length > 10);
      let quiz = `Soal Latihan:\n`;
      sentences.slice(0, 3).forEach((s, i) => {
        quiz += `${i+1}. ${s}\n   a) ...\n   b) ...\n`;
      });
      showAI(quiz);
    }

    function showAI(text) {
      document.getElementById('ai-text').textContent = text;
      document.getElementById('ai-output').style.display = 'block';
    }

    // EXPORT PDF
    function exportPDF() {
      const text = document.getElementById('note-input').value;
      const subject = document.getElementById('subject').value;
      const blob = new Blob([`Mata Pelajaran: ${subject}\n\n${text}`], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${subject}_materi.txt`;
      a.click();
    }

    // SIMPAN
    function saveNote() {
      const text = document.getElementById('note-input').value.trim();
      if (!text) return alert('Kosong!');
      const note = {
        id: Date.now(),
        text,
        subject: document.getElementById('subject').value,
        date: new Date().toLocaleString('id-ID'),
        ai: document.getElementById('ai-text').textContent
      };
      const notes = JSON.parse(localStorage.getItem('rifqyStudyNotes') || '[]');
      notes.unshift(note);
      localStorage.setItem('rifqyStudyNotes', JSON.stringify(notes));
      document.getElementById('note-input').value = '';
      document.getElementById('ai-output').style.display = 'none';
      loadNotes();
      alert('Materi tersimpan!');
    }

    function loadNotes() {
      const notes = JSON.parse(localStorage.getItem('rifqyStudyNotes') || '[]');
      const list = document.getElementById('notes-list');
      if (notes.length === 0) { list.innerHTML = '<div class="empty-state">Belum ada materi.</div>'; return; }
      list.innerHTML = '';
      notes.forEach(n => {
        const div = document.createElement('div'); div.className = 'note-item';
        div.innerHTML = `
          <div style="font-size:12px; opacity:0.7;">${n.subject} • ${n.date}</div>
          <div style="margin:8px 0;">${n.text.substring(0,100)}...</div>
          <div class="note-actions">
            <button onclick="copy('${n.text.replace(/'/g, "\\'")}')">Salin</button>
            <button class="btn-secondary" onclick="del(${n.id})">Hapus</button>
          </div>`;
        list.appendChild(div);
      });
    }

    function copy(t) { navigator.clipboard.writeText(t).then(() => alert('Disalin!')); }
    function del(id) { 
      if (confirm('Hapus?')) { 
        let n = JSON.parse(localStorage.getItem('rifqyStudyNotes')||'[]'); 
        n = n.filter(x=>x.id!==id); 
        localStorage.setItem('rifqyStudyNotes', JSON.stringify(n)); 
        loadNotes(); 
      } 
    }

    // INIT
    loadNotes();
  </script>
</body>
</html>
